//@version=5
strategy("MARCUS: Power Hour Momentum [A-v5] Trailing Only", overlay=true, pyramiding=0,
     default_qty_type=strategy.fixed, default_qty_value=1,
     initial_capital=100000, commission_type=strategy.commission.cash_per_order,
     commission_value=2.06, slippage=1,
     calc_on_every_tick=false, calc_on_order_fills=false)

// ============================================================================
// VARIANT A-v5: TRAILING STOP ONLY (Remove fixed take profit)
// ============================================================================
// Change from Baseline: Remove fixed TP target, use ONLY trailing stop + hard exit.
// Rationale: In strong afternoon trends, fixed TP caps upside. A trailing-only
//   approach lets winners run until either the trail is hit or EOD hard exit.
//   Tests whether the edge is in capturing the full move vs. taking fixed profits.
//   Classic "let your winners run" vs "take what the market gives" test.
// ============================================================================

// === INPUTS ===
string i_rangeSession = input.session("1200-1400", "Consolidation Range Window", group="Range")
int    i_atrLen       = input.int(14, "ATR Period", minval=5, maxval=50, group="Range")
float  i_minRangeMult = input.float(0.5, "Min Range Size (ATR mult)", step=0.1, group="Range")
float  i_maxRangeMult = input.float(3.0, "Max Range Size (ATR mult)", step=0.1, group="Range")

int    i_adxLen       = input.int(14, "ADX Period", minval=5, maxval=30, group="Filters")
float  i_adxThresh    = input.float(20.0, "ADX Min Threshold", step=1.0, group="Filters")
int    i_volLen       = input.int(20, "Volume SMA Length", minval=5, group="Filters")
float  i_volMult      = input.float(1.0, "Volume Filter (mult of avg)", step=0.1, group="Filters")
bool   i_useEma       = input.bool(true, "Use EMA Trend Filter", group="Filters")
int    i_emaLen        = input.int(50, "EMA Period", minval=10, maxval=200, group="Filters")

// -- Risk (CHANGED: Trailing only, no fixed TP) --
float  i_slMult       = input.float(1.5, "Initial Stop Loss ATR Mult", step=0.25, minval=0.5, maxval=5.0, group="Risk")
float  i_tsMult       = input.float(1.5, "Trailing Stop ATR Mult", step=0.25, group="Risk")

string i_tradeSession = input.session("1400-1530", "Trading Entry Window", group="Session")
int    i_hardExitHHMM = input.int(1540, "Hard Exit Time (HHMM ET)", group="Session")

bool   i_enableLong   = input.bool(true, "Enable Long", group="Direction")
bool   i_enableShort  = input.bool(true, "Enable Short", group="Direction")

// === CALCULATIONS ===
int currentHHMM = hour(time, "America/New_York") * 100 + minute(time, "America/New_York")
bool isNewDay = ta.change(time("D")) != 0

float atrVal = ta.atr(i_atrLen)
float emaVal = ta.ema(close, i_emaLen)
[diPlus, diMinus, adxVal] = ta.dmi(i_adxLen, i_adxLen)
float volSma = ta.sma(volume, i_volLen)
bool volOk = volume >= volSma * i_volMult

bool isRangeSession = not na(time(timeframe.period, i_rangeSession + ":1234567", "America/New_York"))
bool isTradeSession = not na(time(timeframe.period, i_tradeSession + ":1234567", "America/New_York"))

var float rangeHigh = na
var float rangeLow  = na
var bool  tradedToday = false

if isNewDay
    rangeHigh  := na
    rangeLow   := na
    tradedToday := false

if isRangeSession
    if na(rangeHigh)
        rangeHigh := high
        rangeLow  := low
    else
        rangeHigh := math.max(rangeHigh, high)
        rangeLow  := math.min(rangeLow, low)

// === ENTRY LOGIC ===
float rangeSize = not na(rangeHigh) ? rangeHigh - rangeLow : 0.0
bool rangeValid = rangeSize >= atrVal * i_minRangeMult and rangeSize <= atrVal * i_maxRangeMult

bool emaLongOk  = not i_useEma or close > emaVal
bool emaShortOk = not i_useEma or close < emaVal
bool adxOk = adxVal >= i_adxThresh

bool longBreakout  = close > rangeHigh and barstate.isconfirmed
bool shortBreakout = close < rangeLow and barstate.isconfirmed

bool longEntry = i_enableLong and isTradeSession and not tradedToday and
     not na(rangeHigh) and rangeValid and
     longBreakout and emaLongOk and adxOk and volOk

bool shortEntry = i_enableShort and isTradeSession and not tradedToday and
     not na(rangeLow) and rangeValid and
     shortBreakout and emaShortOk and adxOk and volOk

// === EXECUTION ===
if longEntry
    strategy.entry("PH Long", strategy.long)
    tradedToday := true

if shortEntry
    strategy.entry("PH Short", strategy.short)
    tradedToday := true

// === EXIT LOGIC ===
// Hard exit at 15:40
if currentHHMM >= i_hardExitHHMM and strategy.position_size != 0
    strategy.close_all("Hard Exit")

// TRAILING STOP ONLY - no fixed TP
// Initial SL provides crash protection, trail takes over once in profit
if strategy.position_size > 0
    float entryP = strategy.opentrades.entry_price(strategy.opentrades - 1)
    float initialSL = entryP - atrVal * i_slMult
    int trailTicks = math.round(atrVal * i_tsMult / syminfo.mintick)
    // Use trail with initial stop as safety net
    strategy.exit("Exit Long", "PH Long", stop=initialSL, trail_offset=trailTicks, trail_points=trailTicks)

if strategy.position_size < 0
    float entryP = strategy.opentrades.entry_price(strategy.opentrades - 1)
    float initialSL = entryP + atrVal * i_slMult
    int trailTicks = math.round(atrVal * i_tsMult / syminfo.mintick)
    strategy.exit("Exit Short", "PH Short", stop=initialSL, trail_offset=trailTicks, trail_points=trailTicks)

// === VISUALIZATION ===
plot(isRangeSession or isTradeSession ? rangeHigh : na, "Range High", color.green, 2, plot.style_linebr)
plot(isRangeSession or isTradeSession ? rangeLow : na, "Range Low", color.red, 2, plot.style_linebr)
plot(i_useEma ? emaVal : na, "EMA", color.blue, 1)

bgcolor(isRangeSession ? color.new(color.gray, 93) : na, title="Range Build")
bgcolor(isTradeSession ? color.new(color.teal, 93) : na, title="Trade Window")

if barstate.islastconfirmedhistory
    var table infoT = table.new(position.top_right, 2, 5, bgcolor=color.new(color.gray, 85))
    table.cell(infoT, 0, 0, "Strategy", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 0, "Power Hour [A-v5] Trail Only", text_color=color.yellow, text_size=size.small)
    table.cell(infoT, 0, 1, "CHANGE", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 1, "No fixed TP, trail + hard exit", text_color=color.lime, text_size=size.small)
    table.cell(infoT, 0, 2, "Regime", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 2, "TRENDING", text_color=color.aqua, text_size=size.small)
    table.cell(infoT, 0, 3, "Max Trades", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 3, "1/day", text_color=color.white, text_size=size.small)
    table.cell(infoT, 0, 4, "Timeframe", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 4, "5min", text_color=color.aqua, text_size=size.small)
