//@version=5
strategy("MARCUS: First Hour Fade [B-v1]", overlay=true, pyramiding=0,
     default_qty_type=strategy.fixed, default_qty_value=1,
     initial_capital=100000, commission_type=strategy.commission.cash_per_order,
     commission_value=2.06, slippage=1,
     calc_on_every_tick=false, calc_on_order_fills=false)

// ============================================================================
// FAMILY B: FIRST HOUR EXHAUSTION FADE (MEAN REVERSION)
// ============================================================================
// Hypothesis: After 45 minutes of opening volatility, overextended moves
//   frequently revert. The opening push creates an exhaustion point that is
//   statistically mean-reverting. Professional traders who missed the
//   initial move fade the extension back to fair value (VWAP).
//
// Complements NQmain: OPPOSITE behavior. NQmain rides breakouts;
//   this strategy fades them. Works best on days NQmain gets stopped out.
//
// Timeframe: 5-minute ONLY
// Target: ~1 trade/day
// Session: 10:15-11:30 ET entry, exit at VWAP touch or 11:30 hard exit
// ============================================================================

// === INPUTS ===
// -- VWAP --
bool   i_useVwap     = input.bool(true, "Use VWAP as Mean Target", group="VWAP")

// -- Extension Detection --
int    i_atrLen       = input.int(14, "ATR Period", minval=5, maxval=50, group="Extension")
float  i_extMult      = input.float(1.5, "Extension Threshold (ATR mult from VWAP)", step=0.1, group="Extension", tooltip="Price must be this far from VWAP to trigger")
int    i_rsiLen       = input.int(14, "RSI Period", minval=5, maxval=30, group="Extension")
float  i_rsiOB        = input.float(70.0, "RSI Overbought", step=5.0, group="Extension")
float  i_rsiOS        = input.float(30.0, "RSI Oversold", step=5.0, group="Extension")

// -- Additional Filters --
bool   i_useVolDecline = input.bool(true, "Require Volume Declining", group="Filters", tooltip="Confirmation that momentum is fading")
int    i_volLen        = input.int(10, "Volume SMA Length", minval=5, group="Filters")
bool   i_useMorningRange = input.bool(true, "Use Morning Range Extreme as Stop", group="Filters")

// -- Risk --
float  i_slMult       = input.float(2.0, "Stop Loss ATR Mult (beyond extreme)", step=0.25, group="Risk")
float  i_tpVwapPct    = input.float(0.3, "Take Profit (fraction of dist to VWAP)", step=0.1, group="Risk", tooltip="0.5 = target halfway back to VWAP, 1.0 = full VWAP touch")

// -- Session --
string i_tradeSession = input.session("1015-1130", "Trading Entry Window", group="Session")
int    i_hardExitHHMM = input.int(1130, "Hard Exit Time (HHMM ET)", group="Session")

// -- Direction --
bool   i_enableLong   = input.bool(true, "Enable Long (fade down)", group="Direction")
bool   i_enableShort  = input.bool(true, "Enable Short (fade up)", group="Direction")

// === CALCULATIONS ===
int currentHHMM = hour(time, "America/New_York") * 100 + minute(time, "America/New_York")
bool isNewDay = ta.change(time("D")) != 0
bool isTradeSession = not na(time(timeframe.period, i_tradeSession + ":1234567", "America/New_York"))

// ATR
float atrVal = ta.atr(i_atrLen)

// RSI
float rsiVal = ta.rsi(close, i_rsiLen)

// VWAP (built-in for intraday)
float vwapVal = ta.vwap(hlc3)

// Volume analysis
float volSma = ta.sma(volume, i_volLen)
bool volDeclining = not i_useVolDecline or (volume < volSma)

// Morning range (9:30-10:15) for stop placement
var float morningHigh = na
var float morningLow  = na
var bool  tradedToday = false

if isNewDay
    morningHigh := na
    morningLow  := na
    tradedToday := false

bool isMorningBuild = currentHHMM >= 930 and currentHHMM < 1015
if isMorningBuild
    if na(morningHigh)
        morningHigh := high
        morningLow  := low
    else
        morningHigh := math.max(morningHigh, high)
        morningLow  := math.min(morningLow, low)

// === EXTENSION DETECTION ===
float distFromVwap = close - vwapVal
float absDistFromVwap = math.abs(distFromVwap)
bool isExtendedUp   = distFromVwap > atrVal * i_extMult
bool isExtendedDown = distFromVwap < -atrVal * i_extMult

// === ENTRY LOGIC ===
// Fade UP (short entry) - price extended above VWAP + RSI overbought + volume fading
bool shortFade = i_enableShort and isTradeSession and not tradedToday and
     isExtendedUp and rsiVal >= i_rsiOB and volDeclining and
     barstate.isconfirmed

// Fade DOWN (long entry) - price extended below VWAP + RSI oversold + volume fading
bool longFade = i_enableLong and isTradeSession and not tradedToday and
     isExtendedDown and rsiVal <= i_rsiOS and volDeclining and
     barstate.isconfirmed

// === EXECUTION ===
if longFade
    strategy.entry("Fade Long", strategy.long)
    tradedToday := true

if shortFade
    strategy.entry("Fade Short", strategy.short)
    tradedToday := true

// === EXIT LOGIC ===
// Hard exit
if currentHHMM >= i_hardExitHHMM and strategy.position_size != 0
    strategy.close_all("Hard Exit 11:30")

// Stop and target
if strategy.position_size > 0
    float entryP = strategy.opentrades.entry_price(strategy.opentrades - 1)
    // Stop: below morning low (or ATR-based)
    float sl = i_useMorningRange and not na(morningLow) ? morningLow - atrVal * 0.5 : entryP - atrVal * i_slMult
    // Target: partial reversion toward VWAP
    float targetDist = math.abs(entryP - vwapVal) * i_tpVwapPct
    float tp = entryP + targetDist
    strategy.exit("Exit Fade Long", "Fade Long", stop=sl, limit=tp)

if strategy.position_size < 0
    float entryP = strategy.opentrades.entry_price(strategy.opentrades - 1)
    // Stop: above morning high (or ATR-based)
    float sl = i_useMorningRange and not na(morningHigh) ? morningHigh + atrVal * 0.5 : entryP + atrVal * i_slMult
    // Target: partial reversion toward VWAP
    float targetDist = math.abs(entryP - vwapVal) * i_tpVwapPct
    float tp = entryP - targetDist
    strategy.exit("Exit Fade Short", "Fade Short", stop=sl, limit=tp)

// === VISUALIZATION ===
plot(vwapVal, "VWAP", color.purple, 2)
plot(vwapVal + atrVal * i_extMult, "Upper Extension", color.new(color.red, 50), 1, plot.style_circles)
plot(vwapVal - atrVal * i_extMult, "Lower Extension", color.new(color.green, 50), 1, plot.style_circles)
plot(isMorningBuild or isTradeSession ? morningHigh : na, "Morning High", color.orange, 1, plot.style_linebr)
plot(isMorningBuild or isTradeSession ? morningLow : na, "Morning Low", color.orange, 1, plot.style_linebr)

bgcolor(isMorningBuild ? color.new(color.blue, 95) : na, title="Morning Range Build")
bgcolor(isTradeSession ? color.new(color.purple, 93) : na, title="Fade Window")

// RSI panel
hline(i_rsiOB, "OB", color.red, linestyle=hline.style_dotted)
hline(i_rsiOS, "OS", color.green, linestyle=hline.style_dotted)

// Info table
if barstate.islastconfirmedhistory
    var table infoT = table.new(position.top_right, 2, 5, bgcolor=color.new(color.gray, 85))
    table.cell(infoT, 0, 0, "Strategy", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 0, "First Hour Fade [B]", text_color=color.yellow, text_size=size.small)
    table.cell(infoT, 0, 1, "Entry Window", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 1, "10:15-11:30 ET", text_color=color.white, text_size=size.small)
    table.cell(infoT, 0, 2, "Regime", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 2, "MEAN REVERSION", text_color=color.fuchsia, text_size=size.small)
    table.cell(infoT, 0, 3, "Max Trades", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 3, "1/day", text_color=color.white, text_size=size.small)
    table.cell(infoT, 0, 4, "Timeframe", text_color=color.white, text_size=size.small)
    table.cell(infoT, 1, 4, "5min", text_color=color.aqua, text_size=size.small)
